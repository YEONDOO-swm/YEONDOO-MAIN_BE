<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.yeondodemo.repository.paper.mapper.PaperMapper">
    <insert id="save">
        insert into PAPER (paperId, conference, cites, likes, lastUpdate, title, url, year, categories, summary, userPdf)
        values (#{paperId}, #{conference},#{cites}, #{likes}, #{lastUpdate}, #{title}, #{url}, #{year}, #{categories}, #{abs}, #{userPdf})
    </insert>

    <insert id="saveF">
        insert into PAPER (paperId,  title, submitter, comments, journalRef, doi,  categories, license, summary, version, update_date, url, year)
        values (#{paperId},  #{title}, #{submitter}, #{comments}, #{journalRef}, #{doi}, #{categories}, #{license}, #{summary}, #{version}, #{update_date}, #{url}, #{year})
    </insert>

    <select id="clearStore">
        TRUNCATE TABLE PAPER
    </select>
    <update id="update">
        update PAPER
        set cites=#{updateParam.cites},
            likes=#{updateParam.likes},
            conference=#{updateParam.conference},
            lastUpdate = #{updateParam.lastUpdate},
            title = #{updateParam.title},
            version = #{updateParam.version},
            url = #{updateParam.url},
            year = #{updateParam.year}
        where paperId = #{id}
    </update>
    <select id="selectRandomReferenceIds" resultType="com.example.yeondodemo.entity.Paper">
        SELECT P.*
        FROM PAPER AS P
                 JOIN (
            SELECT referenceId
            FROM REFERENCE
            WHERE paperId = #{paperId}
            ORDER BY RAND()
                LIMIT 1
        ) AS R ON P.paperId = R.referenceId;

    </select>


    <select id="findById" resultType="com.example.yeondodemo.entity.Paper">
        select *
        from PAPER
        where paperId = #{id}
    </select>

    <update id="add">
        update PAPER
        set likes = likes + 1
        where paperId = #{id}
    </update>

    <update id="sub">
        update PAPER
        set likes = likes - 1
        where paperId = #{id}
    </update>

    <select id="findAllNullPaperId" resultType="String">
        select paperId
        from PAPER
        where isNull(version)
    </select>

    <insert id="saveReferences">
        insert into REFERENCE (paperId, referenceId)
        VALUES
        <foreach collection="references" index="reference" item="reference" separator=",">
            (${paperid}, #{reference})
        </foreach>
    </insert>

    <insert id="saveReference">
        insert into REFERENCE (paperId, referenceId)
        VALUES
        (${paperid}, #{reference})
    </insert>

    <select id="findReferenceById" resultType="PaperSimpleIdTitleDTO">
        SELECT paperId, title
        FROM PAPER
        WHERE paperId in (select referenceId
                          from REFERENCE
                          where paperId = #{paperid})
    </select>

</mapper>